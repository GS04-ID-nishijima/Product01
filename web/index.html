<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script src="js/lib/bootstrap/bootstrap.min.js"></script>
    <script src="js/lib/slick/slick.min.js"></script>
    <script src="js/lib/handlebars/handlebars-v4.0.5.js"></script>
    <script src="js/main.js"></script>
    <link rel="stylesheet" href="css/lib/bootstrap/bootstrap.min.css">
    <link rel="stylesheet" href="css/lib/slick/slick-theme.css">
    <link rel="stylesheet" href="css/lib/slick/slick.css">
    <link rel="stylesheet" href="css/lib/lightbox/lightbox.min.css">
    <link rel="stylesheet" href="css/marche.css">
    <title>Favorite Marche - 今日もマルシェに出掛けよう</title>
</head>

<body>
    <header>
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <h2 class="header-title"><a href="index.html">Favorite Marche</a></h2>
                </div>
            </div>
        </div>
    </header>
    <div>
        <div class="container">
            <div class="row hostinfo-row">
                <div class="col-md-4 hostinfo-col col-md-push-8">
                    <ul class="nav nav-pills nav-justified">
                        <li class="active"><a href="#hostinfo_list_oneweek" data-toggle="pill">1週間以内</a></li>
                        <li><a href="#hostinfo_list_all" data-toggle="pill">すべて</a></li>
                    </ul>
                    <div class="hostinfo-list hidden-xs hidden-sm tab-content">
                        <div id="hostinfo_list_oneweek" class="tab-pane active">
                        </div>
                        <div id="hostinfo_list_all" class="tab-pane">
                        </div>
                    </div>
                </div>
                <div class="col-md-8 hostinfo-col col-md-pull-4">
                    <div id="hostinfomap" class="border-solid map-col">
                    </div>
                </div>
            </div>
        </div>
        <div class="container">
            <div class="row">
                <div class="col-md-12">
                    <div class="latest-photo-col border-solid">
                        <p class="latest-photo-title">最近アップロードされた写真</p>
                        <div class="top-carousel-box">
                            <div class="top-carousel" id="top_carousel">
                            </div>
                        </div>
                     </div>
                </div>
            </div>
        </div>
        <footer>
            <div class="container">
                <div class="row footer-row">
                    <div class="footer-col col-md-6">
                       <div class="footer-contents1">
                        <span class="footer-title">Favorite Marche</span>
                        <span class="footer-inquiry"><a href="#">お問い合わせ</a></span>
                       </div>
                    </div>
                    <div class="footer-col col-md-6 copyright">
                       <div class="footer-contents2">
                        ©2016 Favorite Marche All Rights Reserved.
                       </div>
                    </div>
                </div>
            </div>
        </footer>
    </div>

<script>
var dispInfoWindow;
var marcheMap;
var rangeMode = HOSTINFO_LIST_RANGEMODE_ONE;

$(document).ready(function(){
    // 最新アップロード写真取得
    var sendData;
    sendData = {
        number : 30
    };

    var requet = $.ajax({
        type: 'GET',
        url: '../api/v1/latestphotolist.php',
        cashe: false,
        dataType: "json",
        data: sendData,
        timeout: 10000
    });
    requet.done(function(responseList){
        var topCrouselHtml = "";
        for(var responseListArrayKey in responseList){
            var photoList = responseList[responseListArrayKey];
            var carousel_photo_template = Handlebars.compile($('#carousel_photo_template').html());
            topCrouselHtml = topCrouselHtml + carousel_photo_template(photoList);
        }
        $('#top_carousel').html(topCrouselHtml);

        // カルーセル対応
        $('.top-carousel').slick({
            infinite: false,
            slidesToShow: 5,
            slidesToScroll: 3,
            responsive: [
                {
                  breakpoint: 1210,
                  settings: {
                    slidesToShow: 4,
                    slidesToScroll: 2
                  }
                },
                {
                  breakpoint: 982,
                  settings: {
                    slidesToShow: 3,
                    slidesToScroll: 2
                  }
                },
                {
                  breakpoint: 730,
                  settings: {
                    slidesToShow: 2,
                    slidesToScroll: 1
                  }
                },
                {
                  breakpoint: 360,
                  settings: {
                    slidesToShow: 1,
                    slidesToScroll: 1
                  }
                }
            ]
        });
    });
});

$(document).ajaxError(function(){
        console.log('fail');
        console.log(XMLHttpRequest);
        console.log(textStatus);
        console.log(errorThrown);
});

// google Map 情報ウィンドウ表示
function attachMessage(marker, msg) {
    google.maps.event.addListener(marker, 'click', function(evnt) {
        if(dispInfoWindow) dispInfoWindow.close();
        dispInfoWindow = new google.maps.InfoWindow({
            content: msg
        });
        dispInfoWindow.open(marker.getMap(), marker);
    })
};

// Map初期化
function initMap() {
    // 初期表示地、仮
    var lat = 35.662107;
    var lon = 139.718568;

    marker_list = new google.maps.MVCArray();

    // #hostinfomap「GoogleMap」化
    marcheMap = new google.maps.Map(document.getElementById('hostinfomap'), {
       center: {lat: lat, lng: lon},
       zoom: 14
    });

    google.maps.event.addListener(marcheMap, 'idle', function(){
        viewHostinfoList(rangeMode, marcheMap.getBounds());
    });
};

// 開催情報クリック
function hostinfolist_click(i){
    google.maps.event.trigger(marker_list[i], "click");
};

// 開催情報タブ表示切替
$('a[data-toggle="pill"]').on('shown.bs.tab', function (e) {

    var id = $(e.target).attr("href");
    var bounds = marcheMap.getBounds();

    if(id === '#hostinfo_list_oneweek') {
        rangeMode = HOSTINFO_LIST_RANGEMODE_ONE;
    } else if(id === '#hostinfo_list_all') {
        rangeMode = HOSTINFO_LIST_RANGEMODE_ALL;
    }

    viewHostinfoList(rangeMode, bounds);
});

// 開催情報取得、html描画
function viewHostinfoList(rangeMode, bounds){

    var markerDataArray = new Array();

    var sendData;
    sendData = {
        mode : HOSTINFO_LIST_MODE_SCOPEMAP,
        rangeMode : rangeMode,
        startingPointLatitude : bounds.getSouthWest().lat(),
        startingPointLongitude : bounds.getSouthWest().lng(),
        endPointLatitude : bounds.getNorthEast().lat(),
        endPointLongitude : bounds.getNorthEast().lng()
    };

    var requet = $.ajax({
        type: 'GET',
        url: '../api/v1/hostinfolist.php',
        cashe: false,
        dataType: "json",
        data: sendData,
        timeout: 10000
    });
    requet.done(function(responseList){
        var hostinfoHtml = "";
        var markerCnt = 0;
        for(var hostInfoListArrayKey in responseList['hostInfoList']){
            var hostInfoList = responseList['hostInfoList'][hostInfoListArrayKey];

            var holdingDateYmd = {holdingDateYmd: formatHostinfoDate(hostInfoList.holdingDateYmd) + "開催"};
            var hostinfo_date_header_template = Handlebars.compile($('#hostinfo_date_header_template').html());
            hostinfoHtml += hostinfo_date_header_template(holdingDateYmd);

            for(var hostListArrayKey in hostInfoList.hostList){
                var hostList = hostInfoList.hostList[hostListArrayKey];

                var hostinfo_list_template = Handlebars.compile($('#hostinfo_list_template').html());
                hostList.markerCnt = markerCnt;
                hostinfoHtml += hostinfo_list_template(hostList);

                var infoWindowText_template = Handlebars.compile($('#infoWindowText_template').html());
                var infoWindowTextHtml = infoWindowText_template(hostList);
                markerDataArray.push({
                    position: new google.maps.LatLng(hostList.latitude, hostList.longitude),
                    content: infoWindowTextHtml
                });

                markerCnt++;
            }
        }

        if(rangeMode === HOSTINFO_LIST_RANGEMODE_ONE) {
            $('#hostinfo_list_oneweek').html(hostinfoHtml);
        } else if(rangeMode === HOSTINFO_LIST_RANGEMODE_ALL) {
            $('#hostinfo_list_all').html(hostinfoHtml);
        }

        // Marker作成
        for(i = 0; i < markerDataArray.length; i++){
            var marker = new google.maps.Marker({
                position: markerDataArray[i].position,
                map: marcheMap
            });
            marker_list[i] = marker;
            attachMessage(marker, markerDataArray[i].content);
        }
    });
};

</script>
<script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDzNXQMNe9MNNjRc6Ey4Eg-exdJymnaj-w&callback=initMap"></script>
<script src="js/lib/lightbox/lightbox.min.js"></script>
<script type="text/x-handlebars-template" id="hostinfo_date_header_template">
    <div class="hostinfo-date-header">
        <span class="hostinfo-date">{{holdingDateYmd}}</span>
    </div>
    <div class="hostinfo-space"></div>
</script>
<script type="text/x-handlebars-template" id="hostinfo_list_template">
    <div class="hostinfo-card">
        <p>
            <a href="javascript:hostinfolist_click({{markerCnt}})" class="hostinfo-name">{{hostGroupName}}</a>
        </p>
        <div class="clearfix">
            <img src="../photo/sample_01.jpg" alt="{{hostGroupName}}" class="hostinfo-photo">
            <ul class="hostinfo-contents">
                <li>{{placeName}}</li>
                <li>{{branchScale}}</li>
            </ul>
        </div>
    </div>
    <div class="hostinfo-space"></div>
</script>
<script type="text/x-handlebars-template" id="infoWindowText_template">
    <p><a href="hostgroup.php?hostgroupid={{hostGroupId}}" class="hostinfo-name">{{hostGroupName}}</a></p>
    <ul class="infoWindow-ul">
        <li>{{placeName}}</li>
        <li>{{branchScale}}</li>
    </ul>
</script>
<script type="text/x-handlebars-template" id="carousel_photo_template">
    <div>
        <p><a href="{{filepath}}{{filename}}" data-lightbox="latest-photo-group"><img src="{{filepath}}{{reductionFilename}}" alt="{{comment}}" class="top-carousel-photo"></a></p>
        <p class="top-carousel-comment"><span class="top-carousel-comment-text">{{comment}}</span></p>
    </div>
</script>
</body>
</html>